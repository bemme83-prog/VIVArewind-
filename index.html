<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>VIVA REWIND - INFINITY LOOP</title>
    <style>
        :root { --viva-pink: #ff00ff; --viva-cyan: #00ffff; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        .player-container { position: absolute; inset: 0; transition: opacity 0.5s; background: #000; pointer-events: none; }
        #container-music { z-index: 10; opacity: 1; }
        #container-inter { z-index: 5; opacity: 0; }
        .active { opacity: 1 !important; z-index: 20 !important; }
        #status-box { position: absolute; top: 20px; right: 20px; z-index: 2000; background: rgba(0,0,0,0.8); color: #0f0; padding: 8px; font-family: monospace; font-size: 10px; border: 1px solid #0f0; }
        #overlay { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #fff; }
    </style>
</head>
<body>

<div id="status-box">Loop-Status: Bereit</div>
<div id="overlay" onclick="powerOn()"><h1 style="color:#ffff00">START VIVA</h1></div>

<div id="container-music" class="player-container"><div id="player-music"></div></div>
<div id="container-inter" class="player-container"><div id="player-inter"></div></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let playerMusic, playerInter;
    let watchdog;
    let mode = 'MUSIC';
    let isPreloading = false;
    let interReady = false;
    let hasSwitchedBack = false;
    
    const musicPlaylistId = 'PLfYJatUfKgnlRa5IM0KI_ll0UyhYItnU2';
    const singleIntermissionId = 'h07xiwYGLvs';

    function onYouTubeIframeAPIReady() {
        const commonVars = { autoplay: 0, controls: 0, modestbranding: 1, rel: 0, iv_load_policy: 3, enablejsapi: 1 };

        playerMusic = new YT.Player('player-music', {
            height: '100%', width: '100%',
            playerVars: commonVars,
            events: { 
                'onStateChange': (e) => {
                    if (e.data === YT.PlayerState.PLAYING) {
                        console.log("Musik spielt - Watchdog startet");
                        startWatchdog();
                    }
                    if (e.data === YT.PlayerState.ENDED && mode === 'MUSIC') zapToInter();
                }
            }
        });

        playerInter = new YT.Player('player-inter', {
            height: '100%', width: '100%',
            playerVars: commonVars,
            events: { 
                'onStateChange': (e) => {
                    if (e.data === YT.PlayerState.PLAYING && isPreloading) {
                        playerInter.pauseVideo();
                        isPreloading = false;
                        interReady = true;
                        document.getElementById('status-box').innerText = "EINSPIELER GEPUFFERT";
                    }
                    if (e.data === YT.PlayerState.ENDED && mode === 'INTER') zapToMusic();
                }
            }
        });
    }

    function startWatchdog() {
        clearInterval(watchdog);
        watchdog = setInterval(() => {
            if (mode === 'MUSIC' && playerMusic.getDuration) {
                const duration = playerMusic.getDuration();
                const currentTime = playerMusic.getCurrentTime();
                const timeLeft = duration - currentTime;
                
                // 1. Preload Einspieler (immer wieder neu für jeden Song)
                if (timeLeft <= 45 && !interReady && !isPreloading) {
                    isPreloading = true;
                    console.log("Starte Preload Einspieler...");
                    playerInter.mute();
                    playerInter.loadVideoById(singleIntermissionId);
                }

                // 2. Wechsel bei 3 Sekunden Restzeit
                if (timeLeft <= 3.0 && timeLeft > 0 && interReady) {
                    zapToInter();
                }
                
                document.getElementById('status-box').innerText = "SONG ENDE IN: " + Math.round(timeLeft) + "s";
            }

            if (mode === 'INTER' && playerInter.getDuration) {
                const timeLeftInter = playerInter.getDuration() - playerInter.getCurrentTime();
                if (timeLeftInter <= 3.0 && timeLeftInter > 0 && !hasSwitchedBack) {
                    zapToMusic();
                }
            }
        }, 500);
    }

    function zapToInter() {
        if (mode === 'INTER') return;
        mode = 'INTER';
        hasSwitchedBack = false;
        clearInterval(watchdog); // Watchdog kurz stoppen für Modus-Wechsel
        
        document.getElementById('container-music').style.opacity = "0";
        document.getElementById('container-inter').classList.add('active');
        
        playerInter.unMute();
        playerInter.playVideo();
        
        setTimeout(() => {
            playerMusic.stopVideo();
            startWatchdog(); // Watchdog im INTER-Modus neu starten
        }, 500);
    }

    function zapToMusic() {
        if (hasSwitchedBack) return;
        hasSwitchedBack = true;
        
        mode = 'MUSIC';
        interReady = false; // WICHTIG: Reset für den nächsten Song!
        isPreloading = false; // WICHTIG: Reset für den nächsten Song!
        
        document.getElementById('container-inter').classList.remove('active');
        document.getElementById('container-music').style.opacity = "1";
        
        playerMusic.loadPlaylist({
            list: musicPlaylistId,
            listType: 'playlist',
            index: Math.floor(Math.random() * 50)
        });

        setTimeout(() => {
            playerInter.stopVideo();
        }, 500);
    }

    function powerOn() {
        document.getElementById('overlay').style.display = 'none';
        playerMusic.loadPlaylist({ list: musicPlaylistId, listType: 'playlist', index: Math.floor(Math.random() * 50) });
    }
</script>
</body>
</html>
